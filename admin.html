<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒèªç±³å¯µç‰©ç¾å®¹ - ç®¡ç†å¾Œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-coral: #F28C8C;
            --soft-pink: #FFF0F2;
            --warm-cream: #FFF9E6;
            --warm-brown: #6D4C41;
        }

        body {
            background-color: var(--soft-pink);
            color: var(--warm-brown);
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
        }

        .navbar {
            background-color: var(--primary-coral);
            box-shadow: 0 2px 10px rgba(242, 140, 140, 0.2);
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.5rem;
            color: white !important;
        }

        .container-main {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .card {
            border: 2px solid var(--primary-coral);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(242, 140, 140, 0.1);
        }

        .card-header {
            background-color: var(--primary-coral);
            color: white;
            border-radius: 13px 13px 0 0 !important;
            font-weight: bold;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: var(--warm-cream);
            color: var(--warm-brown);
            border-color: var(--primary-coral);
            font-weight: bold;
        }

        .table tbody tr:hover {
            background-color: rgba(242, 140, 140, 0.1);
        }

        .btn-sm {
            border-radius: 8px;
            font-weight: bold;
        }

        .btn-edit {
            background-color: #4CAF50;
            border: none;
            color: white;
        }

        .btn-edit:hover {
            background-color: #45a049;
            color: white;
        }

        .btn-delete {
            background-color: #f44336;
            border: none;
            color: white;
        }

        .btn-delete:hover {
            background-color: #da190b;
            color: white;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            border: 2px solid var(--primary-coral);
            border-radius: 10px;
            padding: 10px 15px;
        }

        .search-box button {
            background-color: var(--primary-coral);
            border: none;
            color: white;
            border-radius: 10px;
            padding: 10px 30px;
            font-weight: bold;
        }

        .search-box button:hover {
            background-color: #E57373;
        }

        .modal-header {
            background-color: var(--primary-coral);
            color: white;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .form-label {
            font-weight: bold;
            color: var(--warm-brown);
        }

        .form-control, .form-select {
            border: 2px solid #FAD0C4;
            border-radius: 8px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-coral);
            box-shadow: 0 0 8px rgba(242, 140, 140, 0.4);
        }

        .badge-status {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary-coral), #E57373);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .stats-card h3 {
            font-size: 2rem;
            margin: 0;
        }

        .stats-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .table {
                font-size: 0.85rem;
            }

            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸŒ¸ å¿ƒèªç±³å¯µç‰©ç¾å®¹ - ç®¡ç†å¾Œå°</span>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container container-main">
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <h3 id="totalBookings">0</h3>
                    <p>ç¸½é ç´„æ•¸</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <h3 id="todayBookings">0</h3>
                    <p>ä»Šæ—¥é ç´„</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <h3 id="thisMonthBookings">0</h3>
                    <p>æœ¬æœˆé ç´„</p>
                </div>
            </div>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="search-box">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="æœå°‹é£¼ä¸»åç¨±ã€é›»è©±æˆ–å¯µç‰©åç¨±...">
                        <button class="btn" type="button" onclick="searchBookings()">æœå°‹</button>
                        <button class="btn btn-secondary" type="button" onclick="loadBookings()">é‡ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é ç´„è¡¨æ ¼ -->
        <div class="card">
            <div class="card-header">
                ğŸ“‹ é ç´„åˆ—è¡¨
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>é£¼ä¸»åç¨±</th>
                                <th>é›»è©±</th>
                                <th>å¯µç‰©åç¨±</th>
                                <th>å“ç¨®</th>
                                <th>æ€§åˆ¥</th>
                                <th>é ç´„æ™‚é–“</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted">åŠ è¼‰ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç·¨è¼¯é ç´„</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">é£¼ä¸»å§“å</label>
                                <input type="text" class="form-control" id="editOwnerName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">è¯çµ¡é›»è©±</label>
                                <input type="tel" class="form-control" id="editPhoneNumber" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">å¯µç‰©å§“å</label>
                                <input type="text" class="form-control" id="editPetName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">å“ç¨®</label>
                                <input type="text" class="form-control" id="editBreed">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">æ€§åˆ¥</label>
                                <select class="form-select" id="editGender" required>
                                    <option value="å…¬">å…¬</option>
                                    <option value="æ¯">æ¯</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">æ˜¯å¦çµç´®</label>
                                <select class="form-select" id="editIsNeutered" required>
                                    <option value="1">æ˜¯</option>
                                    <option value="0">å¦</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">é«”é‡ (KG)</label>
                                <input type="number" step="0.1" class="form-control" id="editWeight">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ç—…å²èˆ‡ç‰¹æ®Šç‹€æ³</label>
                            <textarea class="form-control" id="editMedicalDetails" rows="2"></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">ç›®å‰æ˜¯å¦ç”¨è—¥</label>
                                <select class="form-select" id="editIsTakingMedication" required>
                                    <option value="1">æ˜¯</option>
                                    <option value="0">å¦</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">è—¥ç‰©èªªæ˜</label>
                                <input type="text" class="form-control" id="editMedicationDetails">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å€‹æ€§</label>
                            <input type="text" class="form-control" id="editPersonality">
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editPhotoConsent">
                            <label class="form-check-label" for="editPhotoConsent">
                                åŒæ„æ‹æ”ç…§ç‰‡
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editIsAgreed" required>
                            <label class="form-check-label" for="editIsAgreed">
                                å·²åŒæ„æœå‹™æ¢æ¬¾
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()" style="background-color: var(--primary-coral); border: none;">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¢ºèªåˆªé™¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ç¢ºå®šè¦åˆªé™¤é€™ç­†é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://petsalon-api.zeabur.app";
        let bookings = [];
        let deleteId = null;
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // åŠ è¼‰æ‰€æœ‰é ç´„
        async function loadBookings() {
            try {
                const response = await fetch(`${API_URL}/bookings`);
                bookings = await response.json();
                renderTable(bookings);
                updateStats();
            } catch (error) {
                console.error('åŠ è¼‰å¤±æ•—:', error);
                alert('åŠ è¼‰é ç´„å¤±æ•—');
            }
        }

        // æœå°‹é ç´„
        async function searchBookings() {
            const keyword = document.getElementById('searchInput').value;
            if (!keyword) {
                loadBookings();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/search/bookings?keyword=${encodeURIComponent(keyword)}`);
                const results = await response.json();
                renderTable(results);
            } catch (error) {
                console.error('æœå°‹å¤±æ•—:', error);
                alert('æœå°‹å¤±æ•—');
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(data) {
            const tbody = document.getElementById('bookingsTable');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æ²’æœ‰é ç´„è¨˜éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(booking => `
                <tr>
                    <td>${booking.id}</td>
                    <td>${booking.owner_name}</td>
                    <td>${booking.phone_number}</td>
                    <td>${booking.pet_name}</td>
                    <td>${booking.breed || '-'}</td>
                    <td>${booking.gender}</td>
                    <td>${new Date(booking.created_at).toLocaleString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-sm btn-edit" onclick="editBooking(${booking.id})">ç·¨è¼¯</button>
                        <button class="btn btn-sm btn-delete" onclick="deleteBooking(${booking.id})">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // ç·¨è¼¯é ç´„
        async function editBooking(id) {
            try {
                const response = await fetch(`${API_URL}/bookings/${id}`);
                const booking = await response.json();
                
                document.getElementById('editId').value = booking.id;
                document.getElementById('editOwnerName').value = booking.owner_name;
                document.getElementById('editPhoneNumber').value = booking.phone_number;
                document.getElementById('editPetName').value = booking.pet_name;
                document.getElementById('editBreed').value = booking.breed || '';
                document.getElementById('editGender').value = booking.gender;
                document.getElementById('editIsNeutered').value = booking.is_neutered;
                document.getElementById('editWeight').value = booking.weight || '';
                document.getElementById('editMedicalDetails').value = booking.medical_details || '';
                document.getElementById('editIsTakingMedication').value = booking.is_taking_medication;
                document.getElementById('editMedicationDetails').value = booking.medication_details || '';
                document.getElementById('editPersonality').value = booking.personality || '';
                document.getElementById('editPhotoConsent').checked = booking.photo_consent;
                document.getElementById('editIsAgreed').checked = booking.is_agreed;
                
                editModal.show();
            } catch (error) {
                console.error('åŠ è¼‰é ç´„å¤±æ•—:', error);
                alert('åŠ è¼‰é ç´„å¤±æ•—');
            }
        }

        // ä¿å­˜ç·¨è¼¯
        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const data = {
                owner_name: document.getElementById('editOwnerName').value,
                phone_number: document.getElementById('editPhoneNumber').value,
                pet_name: document.getElementById('editPetName').value,
                breed: document.getElementById('editBreed').value,
                gender: document.getElementById('editGender').value,
                is_neutered: document.getElementById('editIsNeutered').value === '1',
                weight: document.getElementById('editWeight').value,
                medical_details: document.getElementById('editMedicalDetails').value,
                is_taking_medication: document.getElementById('editIsTakingMedication').value === '1',
                medication_details: document.getElementById('editMedicationDetails').value,
                personality: document.getElementById('editPersonality').value,
                service_type: 'æœªæŒ‡å®š',
                photo_consent: document.getElementById('editPhotoConsent').checked,
                is_agreed: document.getElementById('editIsAgreed').checked
            };

            try {
                const response = await fetch(`${API_URL}/bookings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('âœ… é ç´„å·²æ›´æ–°');
                    editModal.hide();
                    loadBookings();
                } else {
                    alert('âŒ æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±æ•—:', error);
                alert('ä¿å­˜å¤±æ•—');
            }
        }

        // åˆªé™¤é ç´„
        function deleteBooking(id) {
            deleteId = id;
            deleteModal.show();
        }

        // ç¢ºèªåˆªé™¤
        async function confirmDelete() {
            try {
                const response = await fetch(`${API_URL}/bookings/${deleteId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('âœ… é ç´„å·²åˆªé™¤');
                    deleteModal.hide();
                    loadBookings();
                } else {
                    alert('âŒ åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        function updateStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            const todayCount = bookings.filter(b => new Date(b.created_at) >= today).length;
            const monthCount = bookings.filter(b => new Date(b.created_at) >= monthStart).length;

            document.getElementById('totalBookings').textContent = bookings.length;
            document.getElementById('todayBookings').textContent = todayCount;
            document.getElementById('thisMonthBookings').textContent = monthCount;
        }

        // é é¢åŠ è¼‰æ™‚ç²å–æ•¸æ“š
        loadBookings();

        // æœå°‹æ¡†å›è»Šäº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBookings();
            }
        });
    </script>
</body>
</html>
